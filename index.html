<!DOCTYPE html>
<html>

<head>
    <title>Album Picker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100">
    <div id="root"></div>
    <script type="text/babel">
        const MusicLibrary = () => {
            const [albums, setAlbums] = React.useState(() => {
                const saved = localStorage.getItem('musicLibrary');
                return saved ? JSON.parse(saved) : [];
            });
            const [newAlbum, setNewAlbum] = React.useState('');
            const [newArtist, setNewArtist] = React.useState('');
            const [selectedAlbum, setSelectedAlbum] = React.useState(null);
            const [showUpload, setShowUpload] = React.useState(false);
            const [showLibrary, setShowLibrary] = React.useState(true);
            const [filterText, setFilterText] = React.useState('');
            const [yearFilter, setYearFilter] = React.useState('');
            const [genreFilter, setGenreFilter] = React.useState('');

            // Get unique years and genres for filters
            const years = React.useMemo(() =>
                Array.from(new Set(albums.map(a => a.year))).sort().filter(Boolean),
                [albums]
            );

            const genres = React.useMemo(() =>
                Array.from(new Set(albums.map(a => a.genre))).sort().filter(Boolean),
                [albums]
            );

            const filteredAlbums = React.useMemo(() => {
                return albums.filter(album => {
                    const matchesSearch = !filterText ||
                        album.album.toLowerCase().includes(filterText.toLowerCase()) ||
                        album.artist.toLowerCase().includes(filterText.toLowerCase());
                    const matchesYear = !yearFilter || album.year === yearFilter;
                    const matchesGenre = !genreFilter || album.genre === genreFilter;
                    return matchesSearch && matchesYear && matchesGenre;
                });
            }, [albums, filterText, yearFilter, genreFilter]);

            React.useEffect(() => {
                localStorage.setItem('musicLibrary', JSON.stringify(albums));
            }, [albums]);

            const addAlbum = () => {
                if (newAlbum && newArtist) {
                    setAlbums([...albums, {
                        album: newAlbum,
                        artist: newArtist,
                        listens: 0,
                        skips: 0
                    }]);
                    setNewAlbum('');
                    setNewArtist('');
                }
            };

            const removeAlbum = (index) => {
                setAlbums(albums.filter((_, i) => i !== index));
                if (selectedAlbum && selectedAlbum.album === albums[index].album) {
                    setSelectedAlbum(null);
                }
            };

            const pickRandomAlbum = () => {
                if (filteredAlbums.length > 0) {
                    const randomIndex = Math.floor(Math.random() * filteredAlbums.length);
                    setSelectedAlbum(filteredAlbums[randomIndex]);
                }
            };

            const handleListen = () => {
                if (selectedAlbum) {
                    setAlbums(albums.map(album =>
                        album.album === selectedAlbum.album && album.artist === selectedAlbum.artist
                            ? { ...album, listens: (album.listens || 0) + 1 }
                            : album
                    ));
                    setSelectedAlbum(null);
                }
            };

            const handleSkip = () => {
                if (selectedAlbum) {
                    setAlbums(albums.map(album =>
                        album.album === selectedAlbum.album && album.artist === selectedAlbum.artist
                            ? { ...album, skips: (album.skips || 0) + 1 }
                            : album
                    ));
                    setSelectedAlbum(null);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const parser = new DOMParser();
                        const xml = parser.parseFromString(e.target.result, "text/xml");
                        const tracks = xml.getElementsByTagName("dict")[0].getElementsByTagName("dict");
                        const newAlbums = new Set();

                        for (let track of tracks) {
                            const keys = track.getElementsByTagName("key");
                            let albumName = "";
                            let artistName = "";

                            for (let i = 0; i < keys.length; i++) {
                                if (keys[i].textContent === "Album") {
                                    albumName = keys[i].nextElementSibling.textContent;
                                }
                                if (keys[i].textContent === "Artist") {
                                    artistName = keys[i].nextElementSibling.textContent;
                                }
                            }

                            if (albumName && artistName) {
                                newAlbums.add(JSON.stringify({
                                    album: albumName,
                                    artist: artistName,
                                    listens: 0,
                                    skips: 0
                                }));
                            }
                        }

                        const albumsArray = Array.from(newAlbums).map(item => JSON.parse(item));

                        setAlbums(prevAlbums => {
                            const combined = [...prevAlbums, ...albumsArray];
                            const unique = Array.from(new Set(combined.map(a => JSON.stringify(a))))
                                .map(item => JSON.parse(item));
                            return unique;
                        });

                        alert(`Successfully imported ${albumsArray.length} albums!`);
                    };
                    reader.readAsText(file);
                }
            };

            return (
                <div className="max-w-7xl mx-auto p-4 bg-[#1a1a1a] min-h-screen text-white">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-[#3a0a6d] to-[#4a1091] p-6 rounded-t-lg flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <svg className="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5z" />
                            </svg>
                            <h1 className="text-3xl font-bold">Vinyl Voyage</h1>
                        </div>
                        <button
                            onClick={() => setShowLibrary(!showLibrary)}
                            className="px-4 py-2 bg-white/10 rounded-lg hover:bg-white/20"
                        >
                            {showLibrary ? 'Hide Library' : 'Show Library'}
                        </button>
                    </div>

                    <div className="grid grid-cols-[2fr,1fr] gap-4">
                        {/* Main Picker Section */}
                        <div className="bg-[#282828] rounded-b-lg shadow p-6 space-y-6">
                            {/* Filter Section */}
                            <div className="space-y-4">
                                <div className="flex gap-4">
                                    <select
                                        value={yearFilter}
                                        onChange={(e) => setYearFilter(e.target.value)}
                                        className="px-4 py-2 border rounded-lg bg-[#3a3a3a] text-white border-[#4a4a4a]"
                                    >
                                        <option value="">All Years</option>
                                        {years.map(year => (
                                            <option key={year} value={year}>{year}</option>
                                        ))}
                                    </select>

                                    <select
                                        value={genreFilter}
                                        onChange={(e) => setGenreFilter(e.target.value)}
                                        className="px-4 py-2 border rounded-lg bg-[#3a3a3a] text-white border-[#4a4a4a]"
                                    >
                                        <option value="">All Genres</option>
                                        {genres.map(genre => (
                                            <option key={genre} value={genre}>{genre}</option>
                                        ))}
                                    </select>
                                </div>

                                <input
                                    type="text"
                                    placeholder="Search albums or artists..."
                                    value={filterText}
                                    onChange={(e) => setFilterText(e.target.value)}
                                    className="w-full px-4 py-3 border rounded-lg bg-[#3a3a3a] text-white border-[#4a4a4a]"
                                />
                            </div>

                            {/* Random Picker Button */}
                            <button
                                onClick={pickRandomAlbum}
                                className="w-full px-6 py-4 bg-[#E83D54] text-white rounded-lg hover:bg-[#d1354a] font-bold text-lg shadow-lg"
                                disabled={filteredAlbums.length === 0}
                            >
                                Pick Random Album ({filteredAlbums.length} in pool)
                            </button>

                            {/* Selected Album */}
                            {selectedAlbum && (
                                <div className="bg-[#3a3a3a] rounded-lg p-6 shadow-inner border border-[#4a4a4a]">
                                    <h3 className="text-2xl font-bold text-center mb-2">{selectedAlbum.album}</h3>
                                    <p className="text-lg text-gray-300 text-center mb-4">{selectedAlbum.artist}</p>
                                    <div className="flex gap-4">
                                        <button
                                            onClick={handleListen}
                                            className="flex-1 px-6 py-3 bg-[#1DB954] text-white rounded-lg hover:bg-[#1aa34b] font-bold"
                                        >
                                            Listened
                                        </button>
                                        <button
                                            onClick={handleSkip}
                                            className="flex-1 px-6 py-3 bg-[#E83D54] text-white rounded-lg hover:bg-[#d1354a] font-bold"
                                        >
                                            Skip
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Upload Controls */}
                            <div className="border-t border-[#4a4a4a] pt-4">
                                <button
                                    onClick={() => setShowUpload(!showUpload)}
                                    className="text-gray-400 hover:text-white underline"
                                >
                                    {showUpload ? 'Hide Upload Options' : 'Show Upload Options'}
                                </button>

                                {showUpload && (
                                    <div className="mt-4 space-y-4 p-4 bg-[#3a3a3a] rounded-lg">
                                        <input
                                            type="file"
                                            accept=".xml"
                                            onChange={handleFileUpload}
                                            className="w-full p-2 border rounded bg-[#282828] text-white border-[#4a4a4a]"
                                        />
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                placeholder="Album name"
                                                value={newAlbum}
                                                onChange={(e) => setNewAlbum(e.target.value)}
                                                className="flex-1 px-4 py-2 border rounded bg-[#282828] text-white border-[#4a4a4a]"
                                            />
                                            <input
                                                type="text"
                                                placeholder="Artist"
                                                value={newArtist}
                                                onChange={(e) => setNewArtist(e.target.value)}
                                                className="flex-1 px-4 py-2 border rounded bg-[#282828] text-white border-[#4a4a4a]"
                                            />
                                            <button
                                                onClick={addAlbum}
                                                className="px-4 py-2 bg-[#E83D54] text-white rounded hover:bg-[#d1354a]"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Library Section */}
                        {showLibrary && (
                            <div className="bg-[#282828] rounded-b-lg shadow">
                                <div className="p-4 border-b border-[#4a4a4a]">
                                    <h2 className="text-xl font-bold">Your Library</h2>
                                </div>
                                <div className="h-[calc(100vh-16rem)] overflow-y-auto p-4">
                                    <div className="space-y-2">
                                        {filteredAlbums.map((item, index) => (
                                            <div key={index} className="flex justify-between items-start p-3 bg-[#3a3a3a] rounded-lg hover:bg-[#404040]">
                                                <div className="flex-1">
                                                    <div className="font-medium">{item.album}</div>
                                                    <div className="text-sm text-gray-400">{item.artist}</div>
                                                    <div className="text-xs text-gray-500">
                                                        {item.year} • {item.genre}
                                                    </div>
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        Listens: {item.listens || 0} | Skips: {item.skips || 0}
                                                    </div>
                                                </div>
                                                <button
                                                    onClick={() => removeAlbum(index)}
                                                    className="text-[#E83D54] hover:text-[#d1354a]"
                                                >
                                                    ×
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MusicLibrary />);
    </script>
</body>

</html>